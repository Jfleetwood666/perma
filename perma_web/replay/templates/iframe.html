<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Perma.cc + Replayweb.page</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #download-interstitial {
      background-color: #2D76EE;
      border: 0;
      box-sizing: border-box;
      color: white;
      cursor: pointer;
      display: inline-block;
      font-family: "Roboto", Helvetica, Arial, "Lucida Grande", sans-serif;
      font-size: 16px;
      line-height: 22.85px;
      padding: 14px 24px ;
      text-align: center;
      white-space: nowrap
    }
    #download-interstitial:hover, #download-interstitial:focus {
      background-color: #0092FF;
    }
    .button-wrapper {
      margin: auto;
      text-align: center;
    }
    .hidden {
      visibility: hidden;
      display: block;
      height: 10px;
      min-width: 10px;
      width: 10px
    }
    .welcome {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>

  <script src="{{ PLAYBACK_UI_JS_URL }}"></script>
  <script>

    const guid = "{{ guid }}";
    if (guid && window.location != window.parent.location){

      //
      // If we are in an iframe: offer a replay
      //

      const launch_playback = () => {
        const url = "{{ target_url | escapejs }}";
        const warc_source = "{{ warc_source | escapejs }}";
        const embed_style = "{{ embed_style }}";
        const sandbox = {{ sandbox|yesno:"true,false" }}

        console.log(`Requesting playback of Perma Link ${guid} (${url}) from ${warc_source}`)

        const replay = document.createElement('replay-web-page');
        replay.setAttribute('source', warc_source);
        replay.setAttribute('url', url);
        replay.setAttribute('view', 'replay');
        replay.setAttribute('embed', embed_style);
        replay.setAttribute('noSandbox', !sandbox);
        const hidden = {{ hidden|yesno:'true, false' }};
        if (hidden){
          replay.className = 'hidden';
        }
        document.body.appendChild(replay);
        return replay;
      }

      const ondemand = {{ ondemand|yesno:'true, false' }};
      if (ondemand){

        // Insert the download button
        const button = document.createElement('div');
        button.className = 'button-wrapper'
        button.innerHTML = '<button id="download-interstitial">View/Download File</button>';
        document.body.appendChild(button);

        // On-click, trigger replay in a hidden iframe
        const downloadButton = document.getElementById("download-interstitial");
        downloadButton.onclick = async function () {

          const replay = launch_playback();

          // wait until playback is ready and trigger download in a new tab.
          // useful for forcing download when browser behavior is undesirable,
          // for instance, https://github.com/harvard-lil/perma/issues/2056
          const waitForPlayback = async () => {
            const maxPauseSeconds = 60
            let tries = maxPauseSeconds * 60;  // we expect a repaint rate of ~60 times a second, per https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame
            let elem = null;
            while ( !elem && tries > 0) {
              // sleep efficiently until the next repaint
              const pause = await new Promise(resolve => requestAnimationFrame(resolve));
              cancelAnimationFrame(pause);
              // look for the played-back target
              try {
                elem = replay.shadowRoot.querySelector('iframe').contentDocument.querySelector('replay-app-main').shadowRoot.querySelector('wr-coll').shadowRoot.querySelector('wr-coll-replay').shadowRoot.querySelector('iframe')
              } catch (err) {
                if ( !(err.message.includes('is null') || err.message.includes('of null')) ) {
                  throw err;
                }
                tries -= 1
              }
            }
            if (elem) {
              return elem.src;
            }
            throw 'Playback timed out'
          };

          const target = "{{ target }}";
          if (target==='blank'){
            // inject a download link and click it
            const download = document.createElement('a');
            download.href = await waitForPlayback();
            download.target = '_blank'
            download.click()
          }
        }
      } else {
        launch_playback();
      }

    } else {

      //
      // Otherwise, display a simple landing page
      //
      const content = document.createElement('div');
      content.className = 'welcome'
      content.innerHTML = "<div>Welcome.</div>";
      document.body.appendChild(content);

    }
  </script>
</body>
</html>
